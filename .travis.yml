---
os: linux
dist: focal

language: shell

jobs:
  include:
    - name: Lint Ansible
      addons:
        apt:
          packages:
            ansible-lint
      script: ansible-lint

    - name: Lint JSON
      language: node_js
      node_js: node
      before_script: npm install -g jsonlint mustache
      script: |
        echo "{}" > mustache_config.json
        find . -name "*.json" | xargs -n 1 mustache mustache_config.json | jsonlint --quiet --compact

    - name: Lint Markdown
      language: ruby
      install: gem install mdl
      script: mdl --style .mdlstyle.rb *.md docs/

    - name: Lint PowerShell
      before_script:
        - sudo snap install powershell --classic
        - pwsh -c "Install-Module -Name PSScriptAnalyzer -Force"
      script: pwsh -c "Import-Module PSScriptAnalyzer; Invoke-ScriptAnalyzer -Path . -Settings .PSScriptAnalyzerSettings.psd1 -Recurse -EnableExit -ReportSummary"

    - name: Lint Python
      language: python
      python: 3.9
      before_script: pip install flake8
      script: flake8 . --statistics --count

    - name: Lint shell
      before_script: sudo apt-get install -y shellcheck
      script: find . -name "*.sh" | xargs shellcheck --format gcc --severity error

    - name: Lint YAML
      language: python
      python: 3.9
      before_script: pip install yamllint
      script: yamllint .

    - name: Test Powershell
      before_script:
        - sudo snap install powershell --classic
        - pwsh -c "Install-Module -Name Pester -Force; Install-Module -Name PSScriptAnalyzer -Force; Install-Module Az -Force"
      script: pwsh -c './tests/Run_Pester_Tests.ps1'

    - name: Check for dead links in Markdown
      language: node_js
      node_js: node
      before_script: npm install -g markdown-link-check
      script: find . -name "*.md" | xargs -n 1 markdown-link-check -p -c .markdownlinkcheck.json
      env: ALLOWED_FAILURE=true

    - name: Build documentation
      before_script:
        - sudo apt-get update
        - sudo apt-get -y install git python3 python3-pip
        - pip install -r docs/requirements.txt
        - pip list
      script:
        - make -C docs clean
        - make -C docs html
        - pwd
        - ls -alh
        - ls -alh docs/
      deploy:
        keep_history: true
        local_dir: docs/_build
        provider: pages
        skip_cleanup: true
        strategy: git
        target_branch: ci-docs
        token: $GITHUB_TOKEN
        on:
          branch: 1004-automated-documentation

  allow_failures:
    - env: ALLOWED_FAILURE=true
