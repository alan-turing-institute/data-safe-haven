#!/usr/bin/env bash

# Insert package addition instructions
echo "  # To add additional packages update package_lists/requested-<python version>.list"

# Construct combined lists using:
#   1. include requested packages
#   2. include any packages from the utility list
#   3. remove any packages from the non-conda list which will be installed with pip
COMBINED_27=$(mktemp)
cat requested-27.list utility-packages-27.list| sort | uniq | comm -23 - non-conda-27.list > $COMBINED_27
COMBINED_36=$(mktemp)
cat requested-36.list utility-packages-36.list | sort | uniq | comm -23 - non-conda-36.list > $COMBINED_36
COMBINED_37=$(mktemp)
cat requested-37.list utility-packages-37.list | sort | uniq | comm -23 - non-conda-37.list > $COMBINED_37
COMMON_REQUESTED=$(mktemp)
comm -12 $COMBINED_27 $COMBINED_36 | comm -12 - $COMBINED_37 > $COMMON_REQUESTED

# Construct minimal common and environment specific lists
echo "  - export PYTHON_CONDA_COMMON=\"$(cat $COMMON_REQUESTED | tr '\n' ' ' | xargs)\""
echo "  - export PYTHON_CONDA_ONLY27=\"$(comm -23 $COMBINED_27 $COMMON_REQUESTED | tr '\n' ' ' | xargs)\""
echo "  - export PYTHON_CONDA_ONLY36=\"$(comm -23 $COMBINED_36 $COMMON_REQUESTED | tr '\n' ' ' | xargs)\""
echo "  - export PYTHON_CONDA_ONLY37=\"$(comm -23 $COMBINED_37 $COMMON_REQUESTED | tr '\n' ' ' | xargs)\""

# Use lists to construct appropriate environment variables
echo "  # Consolidate package lists for each Python version"
echo "  - export PYTHON27_CONDA_PACKAGES=\"\$PYTHON_CONDA_COMMON \$PYTHON_CONDA_ONLY27\""
echo "  - export PYTHON36_CONDA_PACKAGES=\"\$PYTHON_CONDA_COMMON \$PYTHON_CONDA_ONLY36\""
echo "  - export PYTHON37_CONDA_PACKAGES=\"\$PYTHON_CONDA_COMMON \$PYTHON_CONDA_ONLY37\""

# Construct packages that must be installed with pip
echo "  # Construct lists of packages only available through pip for each Python version"
echo "  - export PYTHON27_PIP_PACKAGES=\"$(cat non-conda-27.list | tr '\n' ' ' | xargs)\""
echo "  - export PYTHON36_PIP_PACKAGES=\"$(cat non-conda-36.list | tr '\n' ' ' | xargs)\""
echo "  - export PYTHON37_PIP_PACKAGES=\"$(cat non-conda-37.list | tr '\n' ' ' | xargs)\""

# Insert block footer
echo "  # === AUTOGENERATED ANACONDA PACKAGES END HERE ==="

rm $COMBINED_27 $COMBINED_36 $COMBINED_37 $COMMON_REQUESTED

