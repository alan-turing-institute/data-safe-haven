#cloud-config

apt:
  # Preserves the existing /etc/apt/sources.list
  preserve_sources_list: true

  # Update apt database on first boot (ie run apt-get update)
  update: true

# List of packages to install with apt-get
packages:
  - openssh-server
  - python3-pip
  - python3-venv

# Add the atiadmin (default) and mirrordaemon users
# lock_passwd: Lock the password to disable password login
users:
  - default
  - name: mirrordaemon
    lock_passwd: True
    sudo: False
    ssh_authorized_keys:
      - EXTERNAL_PUBLIC_SSH_KEY

write_files:
  - path: "/etc/systemd/system/pypiserver.service"
    content: |
      [Unit]
      Description=A minimal PyPI server for use with pip/easy_install.
      After=network.target

      [Service]
      Type=simple
      PIDFile=/var/run/pypiserver.pid
      User=mirrordaemon
      Group=mirrordaemon

      ExecStart=/pypiserver/bin/pypi-server -p 3128 -P . -a . -v --log-file /datadrive/mirrordaemon/pypiserver.log /datadrive/mirrordaemon/pypi/web/packages
      ExecStop=/bin/kill -TERM $MAINPID
      ExecReload=/bin/kill -HUP $MAINPID
      Restart=always

      WorkingDirectory=/datadrive/mirrordaemon/pypi/

      TimeoutStartSec=3
      RestartSec=5

      [Install]
      WantedBy=multi-user.target
  - path: "/pypiserver.app.py.patch"
    content: |
      --- _app.py 2019-04-03 19:02:39.000000000 +0100
      +++ _app.py 2019-04-03 19:07:00.000000000 +0100
      @@ -213,6 +213,19 @@
                   "string")[0].childNodes[0].wholeText.strip()
               response = []
               ordering = 0
      +        # Override package search (which times out) with a lookup from the simple static package index
      +        with open("/datadrive/mirrordaemon/pypi/web/simple/index.html", "r") as f_package_index:
      +            for line in f_package_index.readlines():
      +                if "<a href" in line:
      +                    package_name = line.split(">")[1].split("<")[0]
      +                    if value in package_name:
      +                        d = {'_pypi_ordering': ordering, 'version': 'exists',
      +                             'name': package_name, 'summary': "{} is available".format(package_name)}
      +                        response.append(d)
      +                ordering += 1
      +        call_string = xmlrpclib.dumps((response,), 'search', methodresponse=True)
      +        return call_string
      +        # End of patch
               for p in packages():
                   if p.pkgname.count(value) > 0:
                       # We do not presently have any description/summary, returning
      @@ -229,6 +242,10 @@
       @app.route("/simple/")
       @auth("list")
       def simpleindex():
      +    # Overriding simple index pages with static content
      +    with open("/datadrive/mirrordaemon/pypi/web/simple/index.html", "r") as f_index:
      +        return f_index.read()
      +    # End of patch
           links = sorted(core.get_prefixes(packages()))
           tmpl = """\
           <html>
      @@ -253,7 +270,10 @@
           normalized = core.normalize_pkgname_for_url(prefix)
           if prefix != normalized:
               return redirect('/simple/{0}/'.format(normalized), 301)
      -
      +    # Overriding simple index pages with static content
      +    with open("/datadrive/mirrordaemon/pypi/web/simple/{}/index.html".format(prefix), "r") as f_index:
      +        return f_index.read()
      +    # End of patch
           files = sorted(core.find_packages(packages(), prefix=prefix),
                          key=lambda x: (x.parsed_version, x.relfn))
           if not files:
      @@ -310,6 +330,14 @@
       @app.route('/packages/:filename#.*#')
       @auth("download")
       def server_static(filename):
      +    # Overriding package root check since all packages are in one directory
      +    root = "/datadrive/mirrordaemon/pypi/web/packages"
      +    response = static_file(filename, root=root, mimetype=mimetypes.guess_type(filename)[0])
      +    if config.cache_control:
      +        response.set_header(
      +            "Cache-Control", "public, max-age=%s" % config.cache_control)
      +    return response
      +    # End of patch
           entries = core.find_packages(packages())
           for x in entries:
               f = x.relfn_unix

runcmd:
  # Set up disk
  - echo "*** Setting up local disk... ***"
  - parted /dev/sdc mklabel gpt
  - parted /dev/sdc mkpart primary ext4 0% 100%
  - parted /dev/sdc print
  - sleep 5
  - mkfs -t ext4 /dev/sdc1
  - mkdir -p /datadrive
  - mount /dev/sdc1 /datadrive
  - UUID=$(blkid | grep "/dev/sdc1" | cut -d'"' -f2)
  - sed "s|UUID|UUID=$UUID\t/datadrive\text4\tdefaults,nofail\t1\t2\nUUID|" /etc/fstab > fstab.tmp
  - mv fstab.tmp /etc/fstab
  - mkdir -p /datadrive/mirrordaemon/pypi/web/packages

  # Fix permissions so that mirrordaemon owns its files
  - chown -R mirrordaemon:mirrordaemon /datadrive/mirrordaemon
  - chown -R mirrordaemon:mirrordaemon ~mirrordaemon

  # Install pypiserver with pip
  - echo "*** Installing pypiserver... ***"
  - python3 -m venv pypiserver
  - pypiserver/bin/pip install pypiserver
  # Patch pypiserver so that it uses the static simple index files
  - echo "*** Patching pypiserver to use static index files ***"
  - cd /pypiserver/lib/python3.6/site-packages/pypiserver
  - patch < /pypiserver.app.py.patch
  - cd /

  # Set up pypiserver: 'start' runs it now; 'enable' adds it to the list of services run on boot
  - echo "*** Setting up pypiserver pointing to local disk... ***"
  - systemctl enable pypiserver.service
  - systemctl start pypiserver.service
  - systemctl status pypiserver.service


# Shutdown so that we can tell when the job has finished by polling the VM state
power_state:
  mode: poweroff
  message: "Shutting down as a signal that setup is finished"
  timeout: 30
  condition: True
