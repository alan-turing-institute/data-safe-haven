#cloud-config

apt:
  # Preserves the existing /etc/apt/sources.list
  preserve_sources_list: true

  # Update apt database on first boot (ie run apt-get update)
  update: true

# List of packages to install with apt-get
packages:
  - openssh-server
  - rsync

# Add the atiadmin (default) and mirrordaemon users
users:
  - default
  - name: mirrordaemon
    lock_passwd: True
    sudo: False

write_files:
  - path: "/home/mirrordaemon/internal_mirror_ip_addresses.txt"
    content: |
  - path: "/home/mirrordaemon/push_to_internal_mirror.sh"
    content: |
      #! /bin/bash
      for IP_ADDRESS in $(cat /home/mirrordaemon/internal_mirror_ip_addresses.txt); do
          rsync -rtlzv --delete --progress /datadrive/* mirrordaemon@${IP_ADDRESS}:/datadrive
      done
  - path: "/home/mirrordaemon/pull_from_internet.sh"
    content: |
      #! /bin/bash
      rsync -rtlzv --delete --progress cran.r-project.org::CRAN /datadrive

runcmd:
  # Generate SSH keys for connecting to the internal mirror
  # - do this early since it is pulled out of the VM by the deployment script
  - echo "*** Generating SSH keys for connecting to the internal mirror"
  - ssh-keygen -t rsa -b 2048 -N '' -f id_rsa
  - sed -i 's/root@/mirrordaemon@/' id_rsa.pub
  - mkdir -p ~mirrordaemon/.ssh
  - mv id_rsa id_rsa.pub ~mirrordaemon/.ssh/
  - chmod 0600 ~mirrordaemon/.ssh/id_rsa
  - chmod 0644 ~mirrordaemon/.ssh/id_rsa.pub

  # Upgrade installation then clean up
  - echo "*** Upgrade and clean up apt-get packages... ***"
  - apt-get -y upgrade
  - apt-get clean

  # Set up and partition data disk
  - echo "*** Setting up local disk... ***"
  - (echo n; echo 1; echo ; echo ; echo ; echo w; echo Y) | gdisk /dev/sdc
  - mkfs -t ext4 /dev/sdc1
  - mkdir /datadrive && mount /dev/sdc1 /datadrive
  - UUID=$(blkid | grep "/dev/sdc1" | cut -d'"' -f2)
  - sed "s|UUID|UUID=$UUID\t/datadrive\text4\tdefaults,nofail\t1\t2\nUUID|" /etc/fstab > fstab.tmp
  - mv fstab.tmp /etc/fstab
  - chown -R mirrordaemon /datadrive

  # Set up mirroring
  - chmod u+x ~mirrordaemon/*.sh
  - echo "*** Adding external update (bandersnatch) job to crontab (3am on 4th of each month)... ***"
  - echo "0 3 4 * * mirrordaemon ~mirrordaemon/pull_from_internet.sh" >> /etc/crontab
  - echo "*** Adding internal mirror update job to crontab (2am on 1st of each month)... ***"
  - echo "0 3 1 * * mirrordaemon ~mirrordaemon/push_to_internal_mirror.sh" >> /etc/crontab

  # Fix permissions so that mirrordaemon owns its files
  - chown -R mirrordaemon ~mirrordaemon
  - chgrp -R mirrordaemon ~mirrordaemon

  # Run initial update - this must be done as mirrordaemon
  - echo "*** Populating external mirror for the first time ***"
  - sudo -H -u mirrordaemon bash -c 'echo "This job is running as $USER"; source ~mirrordaemon/pull_from_internet.sh'
  - echo "*** Performing first push to the following internal mirrors ***"
  - cat /home/mirrordaemon/internal_mirror_ip_addresses.txt
  - sudo -H -u mirrordaemon bash -c 'echo "This job is running as $USER"; source ~mirrordaemon/push_to_internal_mirror.sh'

  # Print out some diagnostic information
  - echo "*** This server is currently aware of internal mirrors at the following locations ***"
  - cat /home/mirrordaemon/internal_mirror_ip_addresses.txt
