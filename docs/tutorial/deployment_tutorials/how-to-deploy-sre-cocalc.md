# Secure Research Environment Build Instructions (CoCalc collaborative notebooks)

> :warning: If you are deploying a Tier 2 or Tier 3 environment, you should deploy with an [RDS remote desktop](./how-to-deploy-sre-microsoft-rds.md) instead.
> This CoCalc notebook based user interface does not support the required security level for Tier 2 or above environments, but is suitable for Tier 0 or 1 environments.
> For Tier 0 and 1 environments where a full remote desktop is required, we would recommend deploying with [Guacamole](./how-to-deploy-sre-apache-guacamole.md), which is also recommended for development and testing purposes due to having a more fully automated deployment than the  [RDS remote desktop](./how-to-deploy-sre-microsoft-rds.md).

## Contents

+ [:seedling: Prerequisites](#seedling-prerequisites)
+ [:clipboard: Define SRE Configuration](#clipboard-define-sre-configuration)
+ [:registered: Deploy Key Vault](#registered-deploy-key-vault)
+ [:bicyclist: Optional: Declare Users](#bicyclist-optional-declare-users)
+ [:computer: Deploy and Configure VM](#computer-deploy-and-configure-vm)
+ [:floppy_disk: Uploading Data](#floppy_disk-uploading-data)

## :seedling: Prerequisites

:warning: As the deployment process depends on [`Ansible`](https://www.ansible.com) you must be on a [system supported by ansible](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html) (Linux, macOS, BSD, Solaris).

The following packages are required

+ `PowerShell` with support for Azure
  + Install [PowerShell v6.0 or above](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell)
  + Install the [Azure Powershell module](https://docs.microsoft.com/en-us/powershell/azure/install-az-ps) using `Install-Module -Name Az -RequiredVersion 5.0.0 -Repository PSGallery`
+ `Ansible` (not currently supported on Windows)
  + Install [Ansible](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html)
+ `Python`
  + Install a version `> 3.6`
+ `qrencode`
  + :apple: Install using [Homebrew](https://formulae.brew.sh/formula/qrencode) on macOS
  + :penguin: Install through your package manager on Linux
+ `oathtool`
  + :apple: Install `oath-toolkit` using [Homebrew](https://formulae.brew.sh/formula/oath-toolkit) on macOS
  + :penguin: Install through your package manager on Linux
+ `ssh-keygen`
  + Should be available out-of-the-box for all systems supported by Ansible

## :clipboard: Define SRE configuration

The full configuration details for a new SRE are generated by defining a few "core" properties for the new SRE and the management environment in which it will be deployed.

### :green_apple: Generate SRE Configuration

Follow the steps [here](./how-to-deploy-sre-microsoft-rds.md#clipboard-2-secure-research-environment-configuration) to declare the SHM and SRE configuration properties and generate the full SRE configuration.

> :warning: It is **not** necessary to attach this SRE to an SHM. However, to generate the SRE configuration an existing SHM configuration must be included in the core config file; user accounts should not be created in the SHM as they will not be used.

## :registered: Deploy Key Vault

On your **deployment machine**.

+ Ensure you have the latest version of the Safe Haven repository from [https://github.com/alan-turing-institute/data-safe-haven](https://github.com/alan-turing-institute/data-safe-haven).
+ Open a Powershell terminal and navigate to the `deployment/secure_research_environment/setup` directory within the Safe Haven repository.
+ Ensure you are logged into Azure within PowerShell using the command: `Connect-AzAccount` . This command will give you a URL and a short alphanumeric code. You will need to visit that URL in a web browser and enter the code
  + NB. If your account belongs to multiple Azure tenants (for example, as a guest), you may need to add the `-Tenant <Tenant ID>` flag, where `<Tenant ID>` is the ID of the Azure tenant you want to deploy into.
+ Create a Key Vault in the SRE subscription by running `./Setup_SRE_Key_Vault_And_Users.ps1 -shmId <SHM ID> -sreId <SRE ID>`

## :clubs: Create SRE DNS Zone

+ Follow the steps [here](./how-to-deploy-sre-microsoft-rds.md#create-sre-dns-zone) to deploy a DNS zone for this SRE.

## :bicyclist: [Optional] Declare Users

This step is optional at deploy time - if no users are declared, none will be created and they can be added at a later time.

On your **deployment machine**.

+ The users file is a [YAML](https://yaml.org) file. There is one top-level key `users` which contains a list of users.
+ Each users has
  + Real name
  + Username
  + Path to their public SSH key
  + Admin flag (if true can use sudo)
  + Enabled flag (if true can login)
+ Here is an example users file

``` yaml
---
users:

  - name: Harry Lime
    username: harry
    keyfile: keys/id_harry_rsa.pub
    admin: false
    enabled: true

  - name: Keyser Soze
    username: keyser
    keyfile: ~/.ssh/id_keyser_rsa.pub
    admin: true
    enabled: false
```

## :computer: Deploy and Configure VM

On your **deployment machine**.

+ Deploy a Tier 1 VM by running `./Setup_SRE_Tier1.ps1 -shmId <SHM ID> -sreId <SRE ID>`.
  + If you have a users file pass its path with the `-usersYAMLPath` argument.
  + If not a VM with no additional user accounts will be created and you may add users later.
+ If you have not connected to the VM before, this script will ask you if you want to connect as the authenticity of the host cannot be established.
  + At this point enter `yes` .
+ If you are creating new TOTP hashes for new users there are **expected failures** in the Ansible play.
  + In particular, looking up the existing TOTP hashes for these users will fail.
  + This is expected and not a problem as it prompts the next task to create a TOTP hash for those users.
+ The CoCalc container is large and pulling it may take some time (~20 minutes).
+ To add, or disable user accounts, edit the users file and re-run `./Setup_SRE_Tier1.ps1 -usersYAMLPath <YAML file>` .

## :closed_lock_with_key: Generate SSL certificate

+ Follow the steps [here](./how-to-deploy-sre-microsoft-rds.md#secure-rds-webclient) to generate an SSL certificate for the SRE domain

## :lock: Apply Network Configuration

+ Follow the steps [here](./how-to-deploy-sre-microsoft-rds.md#lock-10-configure-network-lockdown) to apply the network configuration.
+ This may be used to restrict SSH access to particular IP addresses.

## :floppy_disk: Uploading Data

+ `./Setup_SRE_Tier1.ps1` creates a storage account named `sre<SRE id>ingress<random string>` where `<SRE id>` is the SRE ID in lower case and `<random string>` is a random set of lower case characters unique to the SRE.
+ Within that storage account is a file share called `ingress`. This share is mounted at `/data` on the Tier 1 VM.
+ You may upload data to `ingress` using the [Azure Storage Explorer](https://azure.microsoft.com/en-us/features/storage-explorer/).
+ If data is already in another Azure storage account, the easiest way to transfer it is using [`AzCopy`](https://docs.microsoft.com/en-us/learn/modules/copy-blobs-from-command-line-and-code/5-move-blobs-using-azcopy)

## :chart_with_upwards_trend: Migrating to a GPU VM

+ Stop the existing compute VM in the Azure Portal. This VM will be found in the resource group `RG_SRE_<SRE ID>_COMPUTE`.
+ Change the size of the compute VM to a suitable size with a GPU, e.g. NC6.
+ Start the compute VM in the Azure Portal.
+ Ensure you have the `774-tier1-cuda` branch checked out.
+ Run `Setup_SRE_Tier1.ps1 -shmId <SHM ID> -sreId <SRE ID> -usersYAMLPath <YAML file>` where the `<YAML file>` is the path to the YAML file declaring the users.
