---
name: Desired state configuration
hosts: localhost
become: true

tasks:
  - name: Update package cache
    ansible.builtin.apt:
      update_cache: true
      cache_valid_time: 600

  - name: Install apt packages
    ansible.builtin.apt:
      name: "{{ apt_packages.common | union(apt_packages[ansible_facts['distribution_release']]) }}"
      state: present
      async: 3600
      poll: 30

  - name: Copy nslcd configuration
    ansible.builtin.copy:
      src: etc/nslcd.conf
      dest: /etc/nslcd.conf
      mode: '0400'

  - name: Enable bash autocompletion globally
    ansible.builtin.blockinfile:
      path: /etc/bash.bashrc
      block: |
        # enable bash completion in interactive shells
        if [ ! $(shopt -oq posix) ]; then
          if [ -f /usr/share/bash-completion/bash_completion ]; then
              . /usr/share/bash-completion/bash_completion
          elif [ -f /etc/bash_completion ]; then
              . /etc/bash_completion
          fi
        fi

  - name: Copy bashrc skeleton
    ansible.builtin.copy:
      src: etc/skel/bashrc
      dest: /etc/skel/.bashrc
      mode: '0755'

  - name: Copy xsession skeleton
    ansible.builtin.copy:
      src: etc/skel/xsession
      dest: /etc/skel/.xsession
      mode: '0444'
