---
- name: Desired state configuration
  hosts: localhost
  become: true
  vars_files:
    - vars/pulumi_vars.yaml

  tasks:
    - name: Install packages
      ansible.builtin.import_tasks: tasks/packages.yaml

    - name: Disable Ubuntu Pro services
      ansible.builtin.import_tasks: tasks/ubuntu_pro.yaml

    - name: Configure auditd
      ansible.builtin.import_tasks: tasks/auditd.yaml

    - name: Configure sshd
      ansible.builtin.import_tasks: tasks/sshd.yaml

    - name: Configure ClamAV
      ansible.builtin.import_tasks: tasks/clamav.yaml

    - name: Globally configure default user settings
      ansible.builtin.import_tasks: tasks/global_config.yaml

    - name: Configure LDAP
      ansible.builtin.import_tasks: tasks/ldap.yaml

    - name: Configure Xrdp
      ansible.builtin.import_tasks: tasks/xrdp.yaml

    - name: Configure Xfce
      ansible.builtin.import_tasks: tasks/xfce.yaml

    - name: Configure package proxies
      ansible.builtin.import_tasks: tasks/package_proxy.yaml

    - name: Provision smoke tests
      ansible.builtin.import_tasks: tasks/smoke_tests.yaml

  handlers:
    - name: Restart auditd
      ansible.builtin.systemd:
        name: auditd
        state: restarted

    - name: Restart sshd
      ansible.builtin.systemd:
        name: sshd
        state: restarted

    # Run systemd daemon-reload.
    # https://www.freedesktop.org/software/systemd/man/systemctl.html#daemon-reload
    # Should be called when changes are made to .service or .timer files
    - name: Systemd daemon reload
      ansible.builtin.systemd:
        daemon_reload: true
