---
- name: Desired state configuration
  hosts: localhost
  become: true

  tasks:
    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600

    - name: Install apt packages
      ansible.builtin.apt:
        name: "{{ apt_packages.common | union(apt_packages[ansible_facts['distribution_release']]) }}"
        state: present
      async: 3600
      poll: 30


    - name: Enable bash autocompletion globally
      ansible.builtin.blockinfile:
        path: /etc/bash.bashrc
        block: |
          # enable bash completion in interactive shells
          if [ ! $(shopt -oq posix) ]; then
            if [ -f /usr/share/bash-completion/bash_completion ]; then
                . /usr/share/bash-completion/bash_completion
            elif [ -f /etc/bash_completion ]; then
                . /etc/bash_completion
            fi
          fi

    - name: Copy bashrc skeleton
      ansible.builtin.copy:
        src: etc/skel/bashrc
        dest: /etc/skel/.bashrc
        mode: '0755'

    - name: Copy xsession skeleton
      ansible.builtin.copy:
        src: etc/skel/xsession
        dest: /etc/skel/.xsession
        mode: '0444'

    - name: Add ldap to /etc/nsswitch.conf
      ansible.builtin.replace:
        path: /etc/nsswitch.conf
        regexp: '^(passwd|group|shadow)(:.*)(?<!ldap)$'
        replace: '\1\2 ldap'

    - name: Ensure home directories are created on LDAP login
      # Should look to migrate to https://docs.ansible.com/ansible/latest/collections/community/general/pamd_module.html
      ansible.builtin.lineinfile:
        path: /etc/pam.d/common-session
        regexp: '^session required\s+pam_mkhomedir.so'
        line: 'pam_mkhomedir.so skel=/etc/skel umask=0022'
      notify: Update PAM auth

    - name: Don't enforce new passwords on change
      ansible.builtin.lineinfile:
        path: /etc/pam.d/login
        state: absent
        regexp: '^password(.*) use_authtok (.*)$'
        line: 'password\1 \2'

    - name: Enable SSH password authentication
      # Should look to migrate to https://github.com/dev-sec/ansible-collection-hardening
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PasswordAuthentication'
        line: 'PasswordAuthentication yes'
        validate: sshd -T %s
      notify: Restart sshd

    - name: Enable PAM SSH authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^UsePAM'
        line: 'UsePAM yes'
        validate: sshd -T %s
      notify: Restart sshd

    - name: Enable and start xrdp services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - xrdp
        - xrdp-sesman

    - name: Copy test files
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: /root/tests/
        mode: '0700'
      with_fileglob: 'roots/tests/*'


  handlers:
    - name: Restart sshd
      ansible.builtin.systemd:
        name: sshd
        enabled: true
        state: restarted

    - name: Update PAM auth  # noqa: no-changed-when
      ansible.builtin.command:
        cmd: pam-auth-update --enable mkhomedir ldap
