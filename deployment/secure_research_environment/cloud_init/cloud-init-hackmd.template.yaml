#cloud-config

# Create files
write_files:
  - path: "/opt/hackmd/docker-compose.yml"
    permissions: "0400"
    content: |
      version: '3'
      services:
        codimd:
          depends_on:
            - database
          image: nabo.codimd.dev/hackmdio/hackmd:<docker-hackmd-version>
          environment:
            - CMD_ALLOW_ANONYMOUS=false
            - CMD_ALLOW_FREEURL=true
            - CMD_DB_URL=postgres://hackmd:<hackmd-postgres-password>@database:5432/hackmd
            - CMD_EMAIL=false
            - CMD_IMAGE_UPLOAD_TYPE=filesystem
            - CMD_LDAP_BINDCREDENTIALS=<hackmd-bind-creds>
            - CMD_LDAP_BINDDN=<hackmd-bind-dn>
            - CMD_LDAP_PROVIDERNAME=<hackmd-ldap-netbios>
            - CMD_LDAP_SEARCHBASE=<hackmd-ldap-base>
            - CMD_LDAP_SEARCHFILTER=<hackmd-user-filter>
            - CMD_LDAP_URL=<hackmd-ldap-url>
            - CMD_LDAP_USERIDFIELD=sAMAccountName
            - CMD_USECDN=false
          ports:
            # Map port 80 (external) to port 3000 (internal)
            - 80:3000
          networks:
            dockernet:
          restart: always
          volumes:
            - /data/hackmd:/hackmd/public/uploads
        database:
          image: postgres:<docker-postgres-version>
          environment:
            - POSTGRES_USER=hackmd
            - POSTGRES_PASSWORD=<hackmd-postgres-password>
            - POSTGRES_DB=hackmd
          networks:
            dockernet:
          restart: always
          volumes:
            - /data/postgresql:/var/lib/postgresql/data
      networks:
        dockernet:

# Set locale
locale: en_GB.UTF-8

# Configure apt repositories
apt:
  preserve_sources_list: true
  sources:
    gitlab.list:
      source: "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"
      keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88 # Docker Release (CE deb) <docker@docker.com>

# Install necessary apt packages
packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - docker-ce
  - docker-compose
  - ldap-utils
  - software-properties-common
  - wait-for-it
package_update: true
package_upgrade: true

# We know that exactly one data disk will be attached to this VM and it will be attached as lun1
disk_setup:
  /dev/disk/azure/scsi1/lun1:
    table_type: gpt
    layout: True
    overwrite: True
fs_setup:
  - device: /dev/disk/azure/scsi1/lun1
    partition: 1
    filesystem: ext4
mounts:
  - [/dev/disk/azure/scsi1/lun1-part1, /data, ext4, "defaults,nofail"]

# Set hostname
fqdn: <hackmd-fqdn>
hostname: <hackmd-fqdn>

# Add the SRE admin (default) and hackmddaemon users
users:
  - default
  - name: hackmddaemon
    lock_passwd: True # Lock the password to disable password login
    sudo: False       # This user will not have sudo privileges

# Set the NTP server and timezone
# By default we use Google's NTP servers which are incompatible with other servers due to leap-second smearing
ntp:
  pools:
    - <ntp-server>
timezone: <timezone>

# Run other commands
runcmd:
  # Check server settings
  - echo ">=== Hostname ===<"
  - hostnamectl
  - echo ">=== Date/time ===<"
  - timedatectl
  # Configuring attached disks
  - echo ">=== Configuring attached disks... ===<"
  - mkdir -p /data/postgresql
  - mkdir -p /data/hackmd
  - chown -R 1500:1500 /data/hackmd # allow the 'hackmd' user inside the docker container to access this volume
  - ls -alh /data/
  # Ensure that Docker is running
  - echo "Current Docker status..."
  - systemctl start docker
  - systemctl enable docker
  - systemctl status docker
  # Set up the hackmddaemon user
  - echo "Configuring hackmddaemon user..."
  - groupadd docker
  - usermod -aG docker hackmddaemon
  - newgrp docker
  - chown -R hackmddaemon:hackmddaemon /opt/hackmd
  - ls -alh /opt/hackmd
  # Deploy HackMD using Docker
  - echo "Deploying HackMD with Docker..."
  - su hackmddaemon -c "docker-compose -f /opt/hackmd/docker-compose.yml up -d"
  - wait-for-it -h localhost -p 80 -s -t 0 --
  # Check current status
  - echo "Current HackMD Docker status:"
  - docker-compose -f /opt/hackmd/docker-compose.yml ps
  - echo "HackMD Docker logs:"
  - docker-compose -f /opt/hackmd/docker-compose.yml logs --tail=50

# Shutdown so that we can tell when the job has finished by polling the VM state
power_state:
  mode: poweroff
  message: "Shutting down as a signal that setup is finished"
  timeout: 30
  condition: True
