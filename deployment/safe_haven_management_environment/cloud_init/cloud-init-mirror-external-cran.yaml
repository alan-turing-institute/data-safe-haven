#cloud-config

apt:
  # Preserves the existing /etc/apt/sources.list
  preserve_sources_list: true

  # Update apt database on first boot (ie run apt-get update)
  update: true

# List of packages to install with apt-get
packages:
  - openssh-server
  - rsync

# Add the SHM admin (default) and mirrordaemon users
# lock_passwd: Lock the password to disable password login
users:
  - default
  - name: mirrordaemon
    lock_passwd: True
    sudo: False

# Initialise an empty file `internal_mirror_ip_addresses.txt`
# When internal mirrors are deployed, they add their IP address to this file
# Whenever `push_to_internal_mirrors.sh` is run, it will try to rsync to all of the IP addresses in the file
write_files:
  - path: "/home/mirrordaemon/internal_mirror_ip_addresses.txt"
    owner: mirrordaemon:mirrordaemon
    permissions: "0600"
  - path: "/home/mirrordaemon/package_whitelist.txt"
    owner: mirrordaemon:mirrordaemon
    permissions: "0600"
    content: |
      # PACKAGE_WHITELIST
  - path: "/home/mirrordaemon/push_to_internal_mirrors.sh"
    owner: mirrordaemon:mirrordaemon
    permissions: "0700"
    content: |
      #! /bin/bash
      # rsync: make the destination look like the source
      #   -p          preserve permissions
      #   -r          recursive
      #   -t          preserve times
      #   -l          follow symlinks
      #   -v          verbose
      #   --delete    delete files present in destination but not source
      #   --progress  show progress
      echo "$(date +'%Y-%m-%d %H:%M:%S'): Found $(cat /home/mirrordaemon/internal_mirror_ip_addresses.txt | wc -l | xargs) internal mirrors"  | tee -a /datadrive/mirrordaemon/mirrorserver.log
      for IP_ADDRESS in $(cat /home/mirrordaemon/internal_mirror_ip_addresses.txt); do
          echo "$(date +'%Y-%m-%d %H:%M:%S'): Started pushing to the internal mirror at ${IP_ADDRESS}..." | tee -a /datadrive/mirrordaemon/mirrorserver.log
          START_TIME=$(date +%s)
          rsync -prtlv --delete --progress /datadrive/mirrordaemon/www/cran/* mirrordaemon@${IP_ADDRESS}:/datadrive/mirrordaemon/www/cran 2>&1 | tee /datadrive/mirrordaemon/push_to_internal_mirrors.log
          ELAPSED=$(date -u -d "0 $(date +%s) seconds - $START_TIME seconds" +"%H:%M:%S")
          echo "$(date +'%Y-%m-%d %H:%M:%S'): Finished pushing to the internal mirror at $IP_ADDRESS after $ELAPSED" | tee -a /datadrive/mirrordaemon/mirrorserver.log
      done
  - path: "/home/mirrordaemon/pull_from_internet.sh"
    owner: mirrordaemon:mirrordaemon
    permissions: "0700"
    content: |
      #! /bin/bash
      TIER=PLACEHOLDER
      echo "$(date +'%Y-%m-%d %H:%M:%S'): Started pulling from the internet..." | tee -a /datadrive/mirrordaemon/mirrorserver.log
      START_TIME=$(date +%s)
      if [ "$TIER" == "2" ]; then
          # Download all files
          rsync -rtlvz --delete --delete-excluded --exclude=bin/windows/* --exclude=bin/macos*/* --progress cran.r-project.org::CRAN /datadrive/mirrordaemon/www/cran 2>&1 | tee /datadrive/mirrordaemon/pull_from_internet.log
      else
          # Download all whitelisted packages (which might be none)
          WHITELISTED_PACKAGES=$(grep -v "^#" /home/mirrordaemon/package_whitelist.txt)
          # NB. Using an initial '/' anchors the search path at the directory root, speeding up calculation time
          INCLUDE_DIRS="--include=/src/contrib/PACKAGES"
          for RPACKAGE in $WHITELISTED_PACKAGES; do
              INCLUDE_DIRS="${INCLUDE_DIRS} --include=/bin/linux/ubuntu/*/${RPACKAGE}_* --include=/src/contrib/${RPACKAGE}_* --include=/src/contrib/Archive/${RPACKAGE}/* --include=/web/checks/check_results_${RPACKAGE}.html --include=/web/dcmeta/${RPACKAGE}.xml --include=/web/packages/${RPACKAGE}/***"
          done
          # Note that there is a server-side timeout (30s) which might be a problem if this command gets too complicated
          rsync -rtlvz --delete --delete-excluded --prune-empty-dirs --progress --include='*/' --include='/*' $INCLUDE_DIRS --exclude='*' cran.r-project.org::CRAN /datadrive/mirrordaemon/www/cran 2>&1 | tee /datadrive/mirrordaemon/pull_from_internet.log
      fi
      ELAPSED=$(date -u -d "0 $(date +%s) seconds - $START_TIME seconds" +"%H:%M:%S")
      echo "$(date +'%Y-%m-%d %H:%M:%S'): Finished pulling from the internet after $ELAPSED" | tee -a /datadrive/mirrordaemon/mirrorserver.log
  - path: "/home/mirrordaemon/pull_then_push.sh"
    owner: mirrordaemon:mirrordaemon
    permissions: "0700"
    content: |
      #! /bin/bash
      source ~mirrordaemon/pull_from_internet.sh
      source ~mirrordaemon/push_to_internal_mirrors.sh

runcmd:
  # Suppress apt prompts and warning messages
  - export DEBIAN_FRONTEND=noninteractive

  # Generate SSH keys for connecting to the internal mirror
  # - do this early since it is pulled out of the VM by the deployment script
  - echo "*** Generating SSH keys for connecting to the internal mirror"
  - sudo -u mirrordaemon ssh-keygen -t rsa -b 2048 -N '' -f id_rsa

  # Upgrade installation then clean up
  - echo "*** Upgrade and clean up apt-get packages... ***"
  - apt-get -y upgrade
  - apt-get clean

  # Set up and partition data disk
  - echo "*** Setting up local disk... ***"
  - parted /dev/sdc mklabel gpt
  - parted /dev/sdc mkpart primary ext4 0% 100%
  - parted /dev/sdc print
  - sleep 5
  - mkfs -t ext4 /dev/sdc1
  - mkdir -p /datadrive
  - mount /dev/sdc1 /datadrive
  - UUID=$(blkid | grep "/dev/sdc1" | cut -d'"' -f2)
  - sed "s|UUID|UUID=$UUID\t/datadrive\text4\tdefaults,nofail\t1\t2\nUUID|" /etc/fstab > fstab.tmp
  - mv fstab.tmp /etc/fstab
  - mkdir -p /datadrive/mirrordaemon/www/cran

  # Set up mirroring
  - echo "*** Adding internal update (rsync) job to crontab (2am each day)... ***"
  - echo "0 2 * * * mirrordaemon ~mirrordaemon/push_to_internal_mirrors.sh" >> /etc/crontab
  - echo "*** Adding external update (rsync from CRAN) job to crontab (3am each day)... ***"
  - echo "0 3 * * * mirrordaemon ~mirrordaemon/pull_from_internet.sh" >> /etc/crontab

  # Fix permissions so that mirrordaemon owns its files
  - chown -R mirrordaemon:mirrordaemon /datadrive/mirrordaemon

  # Schedule initial update for next boot
  - echo "*** Schedule both mirror update jobs for each boot... ***"
  - echo "@reboot mirrordaemon ~mirrordaemon/pull_then_push.sh" >> /etc/crontab

  # Print out some diagnostic information
  - echo "*** This server is currently aware of internal mirrors at the following locations ***"
  - cat /home/mirrordaemon/internal_mirror_ip_addresses.txt


# Shutdown so that we can tell when the job has finished by polling the VM state
power_state:
  mode: poweroff
  message: "Shutting down as a signal that setup is finished"
  timeout: 30
  condition: True
