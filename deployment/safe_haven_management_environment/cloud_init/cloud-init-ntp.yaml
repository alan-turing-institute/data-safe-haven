#cloud-config

apt:
  # Preserves the existing /etc/apt/sources.list
  preserve_sources_list: true

  # Update apt database on first boot (ie run apt-get update)
  update: true

write_files:
  - path: "/etc/ntp.conf.cloudinit"
    owner: root:root
    permissions: "0644"
    content: |
      # /etc/ntp.conf, configuration for ntpd; see ntp.conf(5) for help
      driftfile /var/lib/ntp/ntp.drift

      # Leap seconds definition provided by tzdata
      leapfile /usr/share/zoneinfo/leap-seconds.list

      # Enable this if you want statistics to be logged.
      statsdir /var/log/ntpstats/

      statistics loopstats peerstats clockstats
      filegen loopstats file loopstats type day enable
      filegen peerstats file peerstats type day enable
      filegen clockstats file clockstats type day enable

      # Specify primary NTP server(s)
      pool pool.ntp.org iburst

      # Specify additional NTP servers for use as fallbacks
      pool time.nist.gov
      pool time.windows.com
      pool time.google.com
      pool time.apple.com
      pool ntp.ubuntu.com

      # Access control configuration; see /usr/share/doc/ntp-doc/html/accopt.html for
      # details.  The web page <http://support.ntp.org/bin/view/Support/AccessRestrictions>
      # might also be helpful.
      #
      # Note that "restrict" applies to both servers and clients, so a configuration
      # that might be intended to block requests from certain clients could also end
      # up blocking replies from your own upstream servers.
      # By default, exchange time with everybody, but don't allow configuration.
      restrict -4 default kod notrap nomodify nopeer noquery limited
      restrict -6 default kod notrap nomodify nopeer noquery limited

      # Needed for adding pool entries
      restrict source notrap nomodify noquery

      # Add local time as a backup if internet connection is lost
      server 127.127.1.0
      fudge 127.127.1.0 stratum 10


# List of packages to install with apt-get
packages:
  - ntp

# Set locale and timezone
locale: en_GB.UTF-8
timezone: <timezone>

runcmd:
  # Set correct NTP configuration
  - mv /etc/ntp.conf.cloudinit /etc/ntp.conf

  # Allow connections from anywhere to port 123
  - ufw allow from any to any port 123 proto udp

# Shutdown so that we can tell when the job has finished by polling the VM state
power_state:
  mode: poweroff
  message: "Shutting down as a signal that setup is finished"
  timeout: 30
  condition: True
